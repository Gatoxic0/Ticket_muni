<div class="ticket-page">
  <div class="ticket-content">
    <!-- Main Content -->
    <div class="main-content">
      <div class="ticket-header">
        <div class="header-left">
          <div class="ticket-title">
            <div class="ticket-id">Ticket #{{ ticket.id }}</div>
          </div>
        </div>
      </div>

      <!-- Ticket Details Card -->
      <div class="ticket-card">
        <div class="card-header">
          <h3>{{ ticket.title }}</h3>
          <div class="ticket-meta">
            <div class="meta-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
              {{ ticket.requesterName }}
            </div>
            <div class="meta-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                <circle cx="12" cy="10" r="3"/>
              </svg>
              {{ ticket.department }}
            </div>
            <div class="meta-item">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11H5a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h4l3 3V8l-3 3z"/>
                <path d="M22 9c0 1.11-.89 2-2 2s-2-.89-2-2 .89-2 2-2 2 .89 2 2z"/>
              </svg>
              {{ getCategoryText(ticket.category) }}
            </div>
          </div>
        </div>
      </div>

      <!-- Thread Section -->
      <div class="thread-card">
        <div class="thread-header">
          <div class="thread-title">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            Hilo del Ticket ({{ responses.length + 1 }})
          </div>
          <div class="thread-actions">
            <button class="thread-action-btn">Tareas</button>
            <button class="thread-action-btn">Hilo</button>
          </div>
        </div>

        <div class="thread-content">
          <!-- Original Message -->
          <div class="message original-message">
            <div class="message-avatar">
              <div 
                class="avatar-circle" 
                [ngClass]="{
                  'admin-avatar': getUserRole(ticket.requesterEmail) === 'admin',
                  'user-avatar': getUserRole(ticket.requesterEmail) === 'user',
                  'unknown-avatar': getUserRole(ticket.requesterEmail) === 'unknown'
                }"
              >
                {{ getInitials(ticket.requesterName) }}
              </div>
            </div>
            <div class="message-content">
              <div class="message-header">
                <div class="flex flex-col">
                  <span class="message-author font-semibold text-base">{{ ticket.requesterName }}</span>
                  <span class="text-sm text-gray-500">{{ ticket.requesterEmail }}</span>
                </div>
                <span class="message-time">publicado {{ formatDate(ticket.createdAt) }}</span>
                <button class="message-reply-btn">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 20l1.3-3.9A9 9 0 1 1 7.7 19L3 20z"/>
                  </svg>
                </button>
              </div>
              <div class="message-body">
                <p>{{ ticket.description }}</p>
              </div>
              <div class="message-footer">
                <span class="message-meta">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2v20m8-8H4"/>
                  </svg>
                  Creado por: {{ ticket.requesterName }} {{ formatDate(ticket.createdAt) }}
                </span>
              </div>
            </div>
          </div>

          <!-- Responses -->
          <div *ngFor="let response of responses" class="message response-message">
            <div class="message-avatar">
              <div 
                class="avatar-circle" 
                [ngClass]="{
                  'admin-avatar': getUserRole(response.authorEmail) === 'admin',
                  'user-avatar': getUserRole(response.authorEmail) === 'user',
                  'unknown-avatar': getUserRole(response.authorEmail) === 'unknown'
                }"
              >
                {{ getInitials(response.author) }}
              </div>
            </div>
            <div class="message-content">
              <div class="message-header">
                <div class="author-info">
                  <span class="message-author">{{ response.author }}</span>
                  <span class="message-email">{{ response.authorEmail }}</span>
                </div>
                <span class="message-time">publicado {{ formatDate(response.timestamp) }}</span>
                <button class="message-reply-btn">...</button>
              </div>
              <div class="message-body">
                <div class="response-content"
                 [innerHTML]="response.message">
                </div>
              </div>
            </div>
          </div>

          <!-- Enhanced Response Form -->
          <div class="response-form">
            <div class="form-header">
              <div class="form-tabs">
                <button class="form-tab active">Publicar Respuesta</button>
                <button class="form-tab">Publicar nota interna</button>
              </div>
            </div>

            <div class="form-content">
              <!-- Quick Response Dropdown -->
              <div class="quick-response-section">
                <label class="quick-response-label">Respuesta:</label>
                <select 
                  class="quick-response-select"
                  [(ngModel)]="selectedQuickResponse"
                  (change)="insertQuickResponse()"
                >
                  <option value="">Seleccione una respuesta predefinida</option>
                  <option *ngFor="let response of quickResponses" [value]="response.text">
                    {{ response.title }}
                  </option>
                </select>
              </div>

              <editor
                [(ngModel)]="newResponse"
                [apiKey]="editorApiKey"
                [init]="editorInit"
              ></editor>

              <!-- Form Footer -->
              <div class="enhanced-form-footer">
                <div class="footer-left">
                  <!-- Signature Options -->
                  <div class="signature-section">
                    <span class="signature-label">Firma:</span>
                    <div class="signature-options">
                      <label class="signature-option">
                        <input 
                          type="radio" 
                          name="signature" 
                          value="none"
                          [(ngModel)]="selectedSignature"
                        />
                        <span>Ninguno</span>
                      </label>
                      <label class="signature-option">
                        <input 
                          type="radio" 
                          name="signature" 
                          value="department"
                          [(ngModel)]="selectedSignature"
                        />
                        <span>Firma del Departamento ({{ ticket.department }})</span>
                      </label>
                    </div>
                  </div>

                  <!-- Ticket Status -->
                  <div class="status-section">
                    <label class="status-label">Estado del Ticket:</label>
                    <select [(ngModel)]="ticket.status" class="status-select">
                      <option value="open">Abrir (actual)</option>
                      <option value="in-progress">En Progreso</option>
                      <option value="resolved">Resuelto</option>
                    </select>
                  </div>
                </div>

                <div class="footer-right">
                  <button 
                    type="button"
                    class="reset-button"
                    (click)="resetForm()"
                  >
                    Restablecer
                  </button>
                  <button 
                    class="send-button"
                    (click)="addResponse()"
                    [disabled]="!newResponse.trim()"
                  >
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                    Publicar Respuesta
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
  </div>
</div>

<!-- Modal para ver imágenes -->
<div 
  class="image-modal-backdrop" 
  *ngIf="isImageModalOpen" 
  (click)="closeImageModal()"
>
  <div class="image-modal-content" (click)="$event.stopPropagation()">
    <img [src]="selectedImageUrl" alt="Imagen ampliada" class="modal-image"/>
    <button class="close-button" (click)="closeImageModal()">×</button>
  </div>
</div>